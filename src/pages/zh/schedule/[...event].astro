---
// Packages
import { Picture } from "astro:assets";
import type { ImageMetadata } from "astro";

// Components
import Layout from "layouts/LayoutLandingZh.astro";
import schedule from "json/ScheduleBilingual.json";
import scheduleForum from "json/Schedule-forum.json";
import speakers from "json/SpeakersZh.json";
import SocialShare from "components/SocialShare.astro";

// Types
type Event = {
  title: string;
  content: string;
  date: string;
  timeSlot: string;
  speakers?: { name: string; image?: string; roleOrg: string }[];
  room?: string;
};

// Generate static paths for events
export async function getStaticPaths() {
  const events: {
    params: { event: string };
    props: { event: Event; category: string };
  }[] = [];

  const createSlug = (title: string) => {
    return title
      .toLowerCase()
      .replace(/[^\w\s\u4e00-\u9fff-]/g, "")  // Keep ASCII word chars, spaces, Chinese chars, and hyphens
      .replace(/\s+/g, "-")
      .replace(/-+/g, "-")
      .replace(/^-+|-+$/g, "")  // Remove leading/trailing hyphens
      .trim();
  };

  // Collect all sessions from all categories in main schedule (bilingual structure)
  Object.entries(schedule.sessions).forEach(([category, categoryEvents]) => {
    categoryEvents.forEach((event: any) => {
      const eventTitle = typeof event.title === 'string' ? event.title : event.title?.zh || event.title?.en || '';
      const eventTitleForSlug = typeof event.title === 'string' ? event.title : event.title?.en || '';
      const transformedEvent = {
        title: eventTitle,
        content: typeof event.content === 'string' ? event.content : event.content?.zh || event.content?.en || '',
        date: typeof event.date === 'string' ? event.date : event.date?.zh || event.date?.en || '',
        timeSlot: event.timeSlot,
        speakers: event.speakers?.map((s: any) => ({
          name: typeof s.name === 'string' ? s.name : s.name?.zh || s.name?.en || '',
          image: s.image,
          roleOrg: typeof s.roleOrg === 'string' ? s.roleOrg : s.roleOrg?.zh || s.roleOrg?.en || ''
        })) || [],
        room: typeof event.room === 'string' ? event.room : event.room?.zh || event.room?.en || ''
      };
      events.push({
        params: {
          event: createSlug(eventTitleForSlug),
        },
        props: { event: transformedEvent, category },
      });
    });
  });

  // Add forum events
  scheduleForum.forEach((event: Event) => {
    events.push({
      params: {
        event: createSlug(event.title),
      },
      props: { event, category: "论坛" },
    });
  });

  return events;
}

// Get the event from the route parameter
const { event: eventDetails, category } = Astro.props as {
  event: Event;
  category: string;
};

// Import all images
const images = import.meta.glob<{ default: ImageMetadata }>(
  "images/speakers/*.{jpeg,jpg,png,gif}"
);

// Find the first matching category for the event
const eventCategory = category || "未分类";

// Get Chinese category name
const getCategoryDisplayName = (categoryId: string) => {
  const categoryMap: Record<string, string> = {
    'gosim-plenary': 'GOSIM 全体大会',
    'ai-models-infra': 'AI 模型 × 基础设施',
    'embodied-ai': '具身智能',
    'agentic-web': '智能体网络',
    'apps-agents': '应用 × 智能体',
    'ai-next': 'AI Next',
    'ws-sglang': 'SGLang Workshop',
    'ws-cangjie': '仓颉 Workshop',
    'ws-dora': 'Dora Workshop',
    'ws-future-web': 'Future Web Workshop',
    'ws-edge-ai': 'Edge AI Workshop',
    'ws-cann': 'CANN Workshop',
    'ws-flutter': 'Flutter Meetup',
    'ws-chitu': '开源赤兔首次聚会',
    'ws-ai-education': 'AI教育 Workshop',
    'ws-rn': 'RN Workshop',
    'ws-rust': 'Rust Workshop',
    'ws-embedded-rust': '嵌入式Rust × AI WorkShop',
    'ws-solana': 'Solana for Rustaceans Workshop',
    'ws-globalization': '开源全球化 Workshop',
    'open-for-sdg': 'Open for SDG 会议',
    'forum-aivision': 'AI Vision 论坛',
    'rust-china-plenary': 'RustChinaConf & Rust Global China',
    'rust-china-1': 'RustChinaConf Track 1',
    'rust-china-2': 'RustChinaConf Track 2',
    'rust-china-3': 'RustChinaConf Track 3'
  };
  return categoryMap[categoryId] || categoryId;
};
---

<Layout
  title={`${eventDetails.title} – GOSIM 杭州 2025`}
  description={eventDetails.content
    .replace(/\n/g, " ")
    .replace(/<[^>]*>/g, "")
    .substring(0, 160)}
  navBackground="light"
  pageTransitionName={eventDetails.title}
>
  <section
    class="section speaker-detail-header"
    data-theme-section="light"
    data-bg-section="light"
  >
    <div class="gradient-circle-wrap">
      <div class="gradient-circle"></div>
    </div>
    <div class="container">
      <div class="row">
        <div class="col-speaker">
          <div class="row-speaker">
            <div class="speaker-row-meta">
              <div class="card-tags group-tags event-tag">
                <div class="single-tag">
                  <p>{getCategoryDisplayName(category)}</p>
                </div>
              </div>
              <h1 class="h2">{eventDetails.title}</h1>
              <div class="flex-event">
                <p class="timedate">{eventDetails.date}</p>
                <p>•</p>
                <p>{eventDetails.timeSlot}</p>
              </div>
            </div>
          </div>

          <div class="box-row box-row-text styled-content">
            <p class="location-text">
              <strong>地点：</strong>
              {
                eventDetails.room ||
                  (() => {
                    // Find category by matching the category ID with the event's category
                    const cat = schedule.categories.find((cat) => cat.id === category);
                    if (cat && cat.room) {
                      return typeof cat.room === 'string' ? cat.room : cat.room?.zh || cat.room?.en || '';
                    }
                    return "待定";
                  })()
              }
            </p>
          </div>

          <div class="box-row box-row-text styled-content">
            <Fragment set:html={eventDetails.content.replace(/\n/g, "<br>")} />
          </div>

          {
            eventDetails.speakers && eventDetails.speakers.length > 0 && (
              <>
                <h2 class="h4 event-speaker-title">讲师</h2>
                <div class="card-row card-row-speakers event-detail_speakers">
                  {eventDetails.speakers.map((speaker) => {
                    // Find full speaker details from unified speakers.json
                    let fullSpeakerDetails = speakers.speakers.find(
                      (s) => s.name === speaker.name || s.id === speaker.id
                    );
                    
                    // Check if this speaker is a workshop speaker based on their tag
                    const workshopCategories = ["ws-future-web", "ws-cann", "ws-flutter", "ws-cangjie", "ws-edge-ai", "ws-chitu", "ws-ai-education", "ws-rn", "ws-dora", "ws-rust", "ws-sglang", "open-for-sdg", "forum-aivision"];
                    let isWorkshopSpeaker = fullSpeakerDetails ? workshopCategories.includes(fullSpeakerDetails.tag) : false;

                    // Determine the correct URL path
                    const speakerPath = isWorkshopSpeaker
                      ? "/zh/workshops/"
                      : "/zh/speakers/";
                    const speakerId =
                      fullSpeakerDetails?.id ||
                      speaker.name.toLowerCase().replace(/\s+/g, "-");

                    return (
                      <div class="card-col">
                        <a href={`${speakerPath}${speakerId}/`}>
                          <div class="single-speakers-card">
                            <div class="card-row card-row-image">
                              <div class="card-image">
                                {(fullSpeakerDetails?.image ||
                                  speaker?.image) &&
                                  images[
                                    `/public/images/speakers/${fullSpeakerDetails?.image || speaker.image}`
                                  ] && (
                                    <Picture
                                      src={images[
                                        `/public/images/speakers/${fullSpeakerDetails?.image || speaker.image}`
                                      ]()}
                                      formats={["webp", "jpg"]}
                                      alt={speaker.name}
                                      class="overlay"
                                      widths={[275, 400, 500, 600, 750, 900]}
                                      sizes="(max-width: 700px) 58vw, 450px"
                                    />
                                  )}
                              </div>
                            </div>
                            <div class="card-row card-row-info">
                              <h3 class="h5">{speaker.name}</h3>
                              <p>
                                {fullSpeakerDetails?.roleOrg || speaker.roleOrg}
                              </p>
                            </div>
                          </div>
                        </a>
                      </div>
                    );
                  })}
                </div>
              </>
            )
          }
          <SocialShare
            title={`${eventDetails.title} - GOSIM 杭州 2025`}
            description={eventDetails.content
              .replace(/\n/g, " ")
              .replace(/<[^>]*>/g, "")
              .substring(0, 160)}
          />
        </div>
      </div>
    </div>
  </section>
</Layout>

<style>
  .location-text {
    font-size: 0.85em;
    padding-bottom: 2rem;
  }
  .gradient-circle-wrap {
    display: flex;
    justify-content: center;
  }
</style>